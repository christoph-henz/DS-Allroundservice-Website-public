# DS-Allroundservice Website

Moderne, datenbankgest√ºtzte Website f√ºr DS-Allroundservice mit umfangreichem Admin-Panel und dynamischen Frageb√∂gen.

## üìã Inhaltsverzeichnis

- [√úbersicht](#√ºbersicht)
- [Technologie-Stack](#technologie-stack)
- [Features - Home-Sektion](#features---home-sektion)
- [Features - Admin-Sektion](#features---admin-sektion)
- [Installation](#installation)
- [Testing](#testing)
- [Projektstruktur](#projektstruktur)

---

## üéØ √úbersicht

Die DS-Allroundservice Website ist eine vollst√§ndige Gesch√§ftsl√∂sung f√ºr Dienstleistungsunternehmen mit:
- **√ñffentlicher Website** f√ºr Kundenanfragen
- **Admin-Panel** f√ºr Verwaltung und Angebotserstellung
- **Dynamischen Frageb√∂gen** f√ºr verschiedene Services
- **Email-Integration** f√ºr Kundenkorrespondenz
- **PDF-Generierung** f√ºr Angebote und Dokumente

---

## üõ†Ô∏è Technologie-Stack

### Backend
- **PHP 7.4+** - Server-side Logik
- **SQLite** - Leichtgewichtige Datenbank
- **PDO** - Datenbank-Abstraction Layer
- **TCPDF** - PDF-Generierung
- **PHPMailer** - Email-Versand
- **IMAP** - Email-Empfang

### Frontend
- **HTML5 / CSS3** - Moderne Webstandards
- **JavaScript (Vanilla)** - Dynamische Interaktionen
- **Responsive Design** - Mobile-First Ansatz
- **CSS Grid & Flexbox** - Moderne Layouts

### Architecture
- **OOP Design** - Objektorientierte Programmierung
- **MVC Pattern** - Model-View-Controller Struktur
- **Router System** - Saubere URL-Verwaltung
- **Session Management** - Sichere Authentifizierung

---

## üè† Features - Home-Sektion

### 1. Landing Page
**Datei:** `src/Views/Home.php`

**Features:**
- ‚úÖ Hero-Sektion mit Call-to-Action
- ‚úÖ Service-√úbersicht Karten
- ‚úÖ Responsive Design (Mobile, Tablet, Desktop)
- ‚úÖ Smooth Scrolling Navigation
- ‚úÖ Performance-optimierte Assets
- ‚úÖ SEO-optimierte Meta-Tags

**Komponenten:**
- Header mit Logo und Navigation
- Service-Karten mit Hover-Effekten
- Kontakt-Sektion
- Footer mit Social Media Links

---

### 2. Service-Seiten (Dynamisch)
**Dateien:** `src/Views/ServicePage.php`, `src/ServiceRouter.php`

**Features:**
- ‚úÖ **Dynamische Service-Seiten** aus Datenbank
- ‚úÖ **Individuelle Hero-Bereiche** pro Service
- ‚úÖ **Pricing-Tabellen** mit konfigurierbaren Preisen
- ‚úÖ **Features-Listen** mit Icons
- ‚úÖ **Intro-Content** mit Rich-Text
- ‚úÖ **SEO-Metadaten** (Title, Description)
- ‚úÖ **Call-to-Action** zum Fragebogen

**Service-Konfiguration:**
```php
- name: Service-Name
- slug: URL-freundlicher Slug
- description: Kurzbeschreibung
- pricing_data: JSON mit Preistabellen
- meta_title: SEO-Titel
- meta_description: SEO-Beschreibung
- hero_title: Haupt-√úberschrift
- intro_content: Einleitungstext
- features_content: Feature-Liste
```

---

### 3. Dynamische Frageb√∂gen
**Dateien:** `src/Views/DynamicQuestionnaire.php`, `public/assets/js/dynamic-questionnaire.js`

**Features:**
- ‚úÖ **Multi-Step Wizard** (Schritt-f√ºr-Schritt Navigation)
- ‚úÖ **Verschiedene Fragetypen:**
  - Text-Eingabe
  - Nummer-Eingabe
  - Ja/Nein (Boolean)
  - Radio-Buttons
  - Checkboxen
  - Dropdown-Listen
  - Textarea (lange Texte)
  - Datum-Auswahl
- ‚úÖ **Conditional Logic** (Bedingte Fragen)
- ‚úÖ **Client-side Validierung**
- ‚úÖ **Fortschrittsanzeige**
- ‚úÖ **Autosave (localStorage)**
- ‚úÖ **Responsive Design**
- ‚úÖ **Accessibility** (Keyboard-Navigation, ARIA-Labels)

**Verf√ºgbare Frageb√∂gen:**
- `/umzug-fragebogen` - Umzug Anfrage
- `/entruempelung-fragebogen` - Entr√ºmpelung Anfrage
- `/transport-fragebogen` - Transport Anfrage

**Features im Detail:**
```javascript
- Echtzeit-Validierung
- Fehlermeldungen inline
- Navigation: Vor/Zur√ºck/Abbrechen
- Progress Bar (0-100%)
- Autosave alle 30 Sekunden
- Daten-Wiederherstellung nach Reload
```

---

### 4. Fragebogen-Submission
**Datei:** `api/submit-questionnaire.php`

**Features:**
- ‚úÖ **Automatische Referenznummer** (z.B. `UMZ-20250109-0001`)
- ‚úÖ **Datenbank-Speicherung** (SQLite)
- ‚úÖ **Email-Benachrichtigung** an Admin
- ‚úÖ **PDF-Generierung** der Anfrage
- ‚úÖ **Session-basierte Erfolgsseite**
- ‚úÖ **Input-Sanitization**
- ‚úÖ **Error Handling**

**Workflow:**
1. Fragebogen ausf√ºllen
2. Validierung (Client + Server)
3. Daten speichern in DB
4. Referenznummer generieren
5. PDF erstellen
6. Email an Admin senden
7. Redirect zur Erfolgsseite

---

### 5. Erfolgsseite (Questionnaire Success)
**Datei:** `src/Views/QuestionnaireSuccess.php`

**Features:**
- ‚úÖ **Session-basierte Datenanzeige** (keine GET-Parameter)
- ‚úÖ **Referenznummer-Anzeige**
- ‚úÖ **Service-Name-Anzeige**
- ‚úÖ **Sicherheits-Features:**
  - Page Reload Protection
  - Session Cleanup nach Anzeige
  - beforeunload Warning
  - localStorage Clearing
- ‚úÖ **Responsive Design**
- ‚úÖ **Call-to-Action** zur√ºck zur Startseite

**Sicherheits-Implementierung:**
```javascript
// Page Reload Warning
window.addEventListener('beforeunload', (e) => {
    e.preventDefault();
    return 'M√∂chten Sie die Seite wirklich verlassen?';
});

// Session Cleanup
fetch('/api/clear-success-session.php')
    .then(() => localStorage.removeItem('success_shown'));
```

---

### 6. Rechtliche Seiten
**Dateien:** `src/Views/Impressum.php`, `src/Views/AGB.php`, `src/Views/Datenschutz.php`

**Features:**
- ‚úÖ **Impressum** - Rechtliche Pflichtangaben
- ‚úÖ **AGB** - Allgemeine Gesch√§ftsbedingungen
- ‚úÖ **Datenschutz** - DSGVO-konforme Datenschutzerkl√§rung
- ‚úÖ **PDF-Download** der Dokumente
- ‚úÖ **Responsive Layout**
- ‚úÖ **Suchmaschinen-freundlich**

**Verf√ºgbare PDFs:**
- Download auf der Website

---

## üîê Features - Admin-Sektion

### 1. Authentifizierung & Session Management
**Dateien:** `api/auth.php`, `src/Utils/AuthMiddleware.php`

**Features:**
- ‚úÖ **Benutzer-Login** mit Username/Password
- ‚úÖ **Password Hashing** (bcrypt)
- ‚úÖ **Session-Management** (sichere Sessions)
- ‚úÖ **Role-Based Access Control** (RBAC)
  - Admin: Volle Rechte
  - Moderator: Create, Read, Update
  - Viewer: Nur Lesen
  - Editor: Create, Read, Update
- ‚úÖ **Logout-Funktion**
- ‚úÖ **Session Timeout**
- ‚úÖ **Remember Me** (Optional)

**Benutzerrollen:**
```php
Admin:     create, read, update, delete, manage_users, manage_settings
Moderator: create, read, update
Viewer:    read
Editor:    create, read, update
```

---

### 2. Dashboard
**Datei:** `src/Views/AdminPage.php` (Dashboard-Sektion)

**Features:**
- ‚úÖ **Statistik-√úbersicht:**
  - Anfragen heute
  - Offene Anfragen
  - Aktive Services
  - Gesamt-Anfragen
- ‚úÖ **Neueste Submissions** (letzte 5)
- ‚úÖ **Service-Performance** (Anfragen pro Service)
- ‚úÖ **Quick Actions:**
  - Neue Anfrage erstellen
  - Service verwalten
  - Emails pr√ºfen
- ‚úÖ **Responsive Dashboard-Layout**
- ‚úÖ **Echtzeit-Daten** (Live-Updates)

**Dashboard-Metriken:**
```php
- Submissions heute: COUNT WHERE DATE(submitted_at) = TODAY
- Offene Anfragen: COUNT WHERE status = 'new'
- Aktive Services: COUNT WHERE is_active = 1
- Service-Stats: GROUP BY service_id
```

---

### 3. Service-Verwaltung
**Datei:** `src/Views/AdminPage.php` (Services-Sektion)

**Features:**
- ‚úÖ **CRUD-Operationen:**
  - ‚úÖ Service erstellen
  - ‚úÖ Service bearbeiten
  - ‚úÖ Service l√∂schen (Soft-Delete)
  - ‚úÖ Service aktivieren/deaktivieren
- ‚úÖ **Service-Konfiguration:**
  - Name & Slug
  - Beschreibung
  - Pricing-Daten (JSON)
  - SEO-Metadaten
  - Hero-Content
  - Intro-Content
  - Features-Liste
- ‚úÖ **Pricing-Tabellen Editor:**
  - Mehrere Preisreihen
  - Von-Bis Preise
  - Einheiten (pauschal, pro m¬≤, pro Stunde)
  - Beschreibungen
- ‚úÖ **Vorschau-Funktion**
- ‚úÖ **Sortierung & Filterung**

**Service-Datenstruktur:**
```sql
CREATE TABLE services (
    id INTEGER PRIMARY KEY,
    name TEXT NOT NULL,
    slug TEXT UNIQUE,
    description TEXT,
    pricing_data TEXT,  -- JSON
    is_active INTEGER DEFAULT 1,
    created_at TEXT,
    updated_at TEXT
)

CREATE TABLE service_page_content (
    service_id INTEGER,
    meta_title TEXT,
    meta_description TEXT,
    hero_title TEXT,
    intro_content TEXT,
    features_content TEXT,
    pricing_data TEXT
)
```

---

### 4. Anfragen-Verwaltung (Submissions)
**Datei:** `src/Views/AdminPage.php` (Submissions-Sektion)

**Features:**
- ‚úÖ **Anfragen-Liste:**
  - Referenznummer
  - Service-Name
  - Status (new, in_progress, completed, cancelled)
  - Eingangsdatum
  - Aktionen (Anzeigen, Bearbeiten, L√∂schen)
- ‚úÖ **Detail-Ansicht:**
  - Alle Fragebogen-Antworten
  - Kundendaten
  - Zeitstempel
  - Status-Historie
- ‚úÖ **Status-Verwaltung:**
  - Status √§ndern (Dropdown)
  - Status-Farben (new=blau, in_progress=gelb, completed=gr√ºn)
- ‚úÖ **Filter & Suche:**
  - Nach Status filtern
  - Nach Service filtern
  - Nach Datum filtern
  - Freitext-Suche (Referenznummer, Name)
- ‚úÖ **Sortierung:**
  - Nach Datum (neueste zuerst)
  - Nach Status
  - Nach Service
- ‚úÖ **PDF-Generierung:**
  - Anfrage als PDF exportieren
  - Automatische PDF-Speicherung
- ‚úÖ **Angebotserstellung:**
  - Direkter Link zum Angebot erstellen
  - Pre-fill mit Anfragedaten

**Submission-Workflow:**
```
new ‚Üí in_progress ‚Üí completed
                 ‚Üò cancelled
```

---

### 5. Angebotserstellung & PDF-Export
**Datei:** `src/Views/AdminPage.php` (Offers-Sektion)

**Features:**
- ‚úÖ **Angebots-Generator:**
  - Referenznummer (basierend auf Anfrage)
  - Kundendaten (aus Anfrage)
  - Service-Auswahl
  - Positionen-Tabelle (Beschreibung, Menge, Einzelpreis, Gesamt)
  - Zwischensumme, MwSt., Gesamt
  - G√ºltigkeit (Datum)
  - Zus√§tzliche Notizen
- ‚úÖ **PDF-Generierung (TCPDF):**
  - Firmen-Logo
  - Professionelles Layout
  - Mehrere Positionen
  - Steuerberechnung
  - Footer mit Kontaktdaten
- ‚úÖ **PDF-Speicherung:**
  - `data/offers/angebot_[REF]_[TIMESTAMP].pdf`
  - Automatische Versionierung
- ‚úÖ **Angebots-Versand:**
  - Email mit PDF-Anhang
  - Angebot per Post
- ‚úÖ **Angebots-Historie:**
  - Alle erstellten Angebote
  - Status (Entwurf, Versendet, Angenommen, Abgelehnt)
  - Zeitstempel

**PDF-Features:**
```php
- TCPDF Library
- A4 Format
- Header: Logo + Firmenname
- Kunden-Adresse (links oben)
- Angebots-Details (Datum, Referenz, G√ºltigkeit)
- Positions-Tabelle mit Preisen
- MwSt.-Berechnung (19%)
- Footer: Kontaktdaten, Bankverbindung
- Seitenzahlen
```

---

### 6. Fragebogen-Builder
**Datei:** `api/questionnaire-builder.php`

**Features:**
- ‚úÖ **Fragebogen erstellen:**
  - Titel & Slug
  - Service-Verkn√ºpfung
  - Status (draft, active, archived)
  - Versions-Verwaltung
- ‚úÖ **Fragen-Editor:**
  - Frage-Text
  - Frage-Typ ausw√§hlen (text, number, boolean, etc.)
  - Optionen konfigurieren (f√ºr Radio/Checkbox/Dropdown)
  - Validierung definieren (required, min, max, pattern)
  - Hilfetext hinzuf√ºgen
  - Reihenfolge festlegen
- ‚úÖ **Gruppen-Management:**
  - Fragen in Gruppen organisieren
  - Gruppen mit Drag & Drop sortieren
  - Gruppenbeschreibungen
- ‚úÖ **Feste Kontaktfelder (NEU):**
  - Automatische "Kontaktinformationen"-Gruppe
  - 5 Standard-Felder: Vorname, Nachname, E-Mail, Telefon, Mobil
  - Nicht bearbeitbar oder l√∂schbar
  - Immer als erste Gruppe angezeigt
  - Dokumentation: `migrations/FIXED_CONTACT_FIELDS_README.md`
- ‚úÖ **Conditional Logic:**
  - Fragen basierend auf Antworten anzeigen
  - "Zeige Frage X wenn Antwort Y = Z"
- ‚úÖ **CRUD-Operationen:**
  - Fragebogen erstellen
  - Fragebogen bearbeiten
  - Fragebogen duplizieren
  - Fragebogen l√∂schen
  - Fragen hinzuf√ºgen/bearbeiten/l√∂schen
  - Gruppen erstellen/bearbeiten/l√∂schen
- ‚úÖ **Vorschau-Modus:**
  - Live-Vorschau des Fragebogens
  - Test-Submission

**Questionnaire-Datenstruktur:**
```sql
CREATE TABLE questionnaires (
    id INTEGER PRIMARY KEY,
    service_id INTEGER,
    title TEXT,
    slug TEXT UNIQUE,
    status TEXT,  -- draft, active, archived
    version INTEGER,
    created_at TEXT
)

CREATE TABLE question_groups (
    id INTEGER PRIMARY KEY,
    questionnaire_id INTEGER,
    name TEXT,
    description TEXT,
    sort_order INTEGER,
    is_fixed BOOLEAN,  -- NEU: Feste Gruppen (nicht l√∂schbar)
    is_active BOOLEAN
)

CREATE TABLE questions (
    id INTEGER PRIMARY KEY,
    group_id INTEGER,
    text TEXT,
    type TEXT,  -- text, number, boolean, radio, checkbox, select, textarea, date
    options TEXT,  -- JSON f√ºr Auswahlm√∂glichkeiten
    validation TEXT,  -- JSON f√ºr Validierungsregeln
    is_required INTEGER,
    is_fixed BOOLEAN,  -- NEU: Feste Fragen (nicht l√∂schbar)
    sort_order_in_group INTEGER,  -- NEU: Sortierung innerhalb Gruppe
    help_text TEXT,
    order_index INTEGER,
    conditional_logic TEXT  -- JSON
)
```

---

### 7. Benutzer-Verwaltung
**Datei:** `src/Views/AdminPage.php` (Users-Sektion)

**Features:**
- ‚úÖ **Benutzer-Liste:**
  - Username
  - Email
  - Rolle (Admin, Moderator, Viewer, Editor)
  - Status (Aktiv/Inaktiv)
  - Letzter Login
  - Erstellt am
- ‚úÖ **CRUD-Operationen:**
  - Benutzer erstellen
  - Benutzer bearbeiten
  - Benutzer deaktivieren (Soft-Delete)
  - Passwort zur√ºcksetzen
- ‚úÖ **Rollen-Verwaltung:**
  - Rolle zuweisen/√§ndern
  - Berechtigungen anzeigen
- ‚úÖ **Sicherheits-Features:**
  - Password Hashing (bcrypt)
  - Email-Validierung
  - Unique Username/Email
  - Passwort-St√§rke-Pr√ºfung (min. 8 Zeichen)
- ‚úÖ **Filter & Suche:**
  - Nach Rolle filtern
  - Nach Status filtern
  - Freitext-Suche

**User-Datenstruktur:**
```sql
CREATE TABLE users (
    id INTEGER PRIMARY KEY,
    username TEXT UNIQUE,
    email TEXT UNIQUE,
    password TEXT,  -- bcrypt hash
    role TEXT,  -- Admin, Moderator, Viewer, Editor
    is_active INTEGER,
    first_name TEXT,
    last_name TEXT,
    created_at TEXT,
    last_login TEXT
)
```

---

### 8. Einstellungen (Settings)
**Datei:** `src/Views/AdminPage.php` (Settings-Sektion)

**Features:**
- ‚úÖ **System-Einstellungen:**
  - Site Name
  - Contact Email
  - Support Email
  - Max Upload Size
  - Session Timeout
  - Date Format
  - Timezone
- ‚úÖ **Email-Einstellungen:**
  - SMTP Host
  - SMTP Port
  - SMTP Username/Password
  - From Address
  - From Name
- ‚úÖ **PDF-Einstellungen:**
  - Company Logo Path
  - Footer Text
  - Default Font
  - Page Margins
- ‚úÖ **Einstellungs-Typen:**
  - String
  - Number
  - Boolean
  - JSON
  - Text (Textarea)
- ‚úÖ **√ñffentlich/Privat:**
  - √ñffentliche Settings (Frontend-zug√§nglich)
  - Private Settings (nur Admin)
- ‚úÖ **Einstellungs-Kategorien:**
  - Allgemein
  - Email
  - PDF
  - Sicherheit
  - Features

**Settings-Datenstruktur:**
```sql
CREATE TABLE settings (
    id INTEGER PRIMARY KEY,
    key TEXT UNIQUE,
    value TEXT,
    type TEXT,  -- string, number, boolean, json, text
    description TEXT,
    is_public INTEGER,  -- 1 = √∂ffentlich, 0 = privat
    category TEXT
)
```

---

### 9. Email-Inbox System
**Dateien:** `src/Utils/EmailInbox.php`, `src/Views/AdminPage.php` (Emails-Sektion)

**Features:**
- ‚úÖ **IMAP-Integration:**
  - Email-Abruf von Server
  - Multi-Account Support
  - SSL/TLS Verbindung
- ‚úÖ **Email-Liste:**
  - Absender (Von)
  - Betreff
  - Datum
  - Status (Gelesen/Ungelesen)
  - Anh√§nge-Indikator
- ‚úÖ **Email-Detail-Ansicht:**
  - Vollst√§ndige Email-Anzeige
  - HTML & Plain-Text Support
  - Anh√§nge anzeigen/downloaden
  - Header-Informationen
- ‚úÖ **Email-Verwaltung:**
  - Als gelesen/ungelesen markieren
  - Email l√∂schen
  - Email archivieren
  - In Ordner verschieben
- ‚úÖ **Unread-Status Management:**
  - FT_PEEK Flag (Email bleibt ungelesen beim Abrufen)
  - Unread Counter
  - Visual Indicators (fett = ungelesen)
- ‚úÖ **Paged Loading:**
  - 20 Emails pro Seite
  - "Load More" Button
  - Performance-Optimierung
- ‚úÖ **Filter & Suche:**
  - Nach Status (gelesen/ungelesen)
  - Nach Datum
  - Freitext-Suche (Betreff, Absender)
- ‚úÖ **Auto-Refresh:**
  - Automatisches Laden neuer Emails (geplant)
  - Manual Refresh Button

**Email-Features im Detail:**
```php
- IMAP Connection mit FT_PEEK
- Attachment Handling
- HTML Email Rendering
- XSS Protection
- Email Threads
- Search Functionality
- Inbox Pagination
- Unread Counter Badge
```

---

### 10. Search & Filter System
**Datei:** `src/Views/AdminPage.php` (Alle Sektionen)

**Features:**
- ‚úÖ **Globale Suche:**
  - √úber alle Datentypen hinweg suchen
  - Relevanz-Ranking
- ‚úÖ **Sektion-spezifische Suche:**
  - Submissions: Referenznummer, Name, Email
  - Services: Name, Slug, Beschreibung
  - Users: Username, Email, Name
  - Emails: Betreff, Absender
- ‚úÖ **Advanced Filters:**
  - Datum-Range (Von-Bis)
  - Status-Filter (Dropdown)
  - Service-Filter
  - Rolle-Filter
- ‚úÖ **Sortierung:**
  - Aufsteigend/Absteigend
  - Nach Spalte
  - Custom Sort Logic
- ‚úÖ **Live-Search:**
  - Echtzeit-Filterung w√§hrend Eingabe
  - Debounced Input (300ms)
  - Highlight Matches

---

### 11. Responsive Admin-Design
**Datei:** `public/assets/css/admin.css`

**Features:**
- ‚úÖ **Mobile-First Design**
- ‚úÖ **Sidebar-Navigation:**
  - Collapsible auf Mobile
  - Icons + Labels
  - Active State Indicator
- ‚úÖ **Responsive Tables:**
  - Horizontal Scroll auf Mobile
  - Sticky Headers
  - Compact Mode
- ‚úÖ **Touch-Optimiert:**
  - Gro√üe Click-Targets (min. 44x44px)
  - Swipe-Gesten
  - Touch-Feedback
- ‚úÖ **Breakpoints:**
  - Mobile: < 768px
  - Tablet: 768px - 1024px
  - Desktop: > 1024px

---

## üß™ Testing

### Unit Tests
**Datei:** `tests/AdminPageTest.php`

**Features:**
- ‚úÖ **40 Unit Tests** f√ºr AdminPage-Features
- ‚úÖ **Standalone Framework** (kein PHPUnit erforderlich)
- ‚úÖ **Test-Kategorien:**
  - Authentication (4 Tests)
  - Dashboard Statistics (4 Tests)
  - Service Management (6 Tests)
  - Submission Management (4 Tests)
  - User Management (6 Tests)
  - Settings Management (5 Tests)
  - Search & Filter (3 Tests)
  - Input Validation (3 Tests)
  - Permissions (3 Tests)
  - Utilities (4 Tests)

**Ausf√ºhrung:**
```bash
php tests/AdminPageTest.php
```

**Ergebnis:**
```
Total:  40
Passed: 40
Failed: 0
```

---

### Integration Tests
**Datei:** `tests/AdminPageIntegrationTest.php`

**Features:**
- ‚úÖ **54 Integration Tests** (28 API + 26 Authorization)
- ‚úÖ **API-Endpoint Testing:**
  - GET, POST, PUT, DELETE
  - JSON Response Validation
  - Database Operations
- ‚úÖ **Authorization Testing:**
  - Role-Based Access Control
  - Unauthorized Access Prevention
  - Permission Validation
- ‚úÖ **Test-Kategorien:**
  - API Data Retrieval (5 Tests)
  - Service Management API (3 Tests)
  - Submission Management API (4 Tests)
  - User Management API (5 Tests)
  - Settings API (4 Tests)
  - Questionnaire API (4 Tests)
  - Service Page Content API (2 Tests)
  - Dashboard Statistics (2 Tests)
  - **Authorization & Permissions (26 Tests)**

**Authorization Tests:**
- ‚úÖ Unauthorized access prevention
- ‚úÖ Viewer role restrictions (read-only)
- ‚úÖ Moderator role limitations (no delete, no user/settings management)
- ‚úÖ Admin full permissions
- ‚úÖ Editor role (create, read, update)
- ‚úÖ Unknown role = no permissions
- ‚úÖ Inactive user cannot login
- ‚úÖ Session validation

**Ausf√ºhrung:**
```bash
php tests/AdminPageIntegrationTest.php
```

**Ergebnis:**
```
Total:  54
Passed: 54
Failed: 0
```

---

## üìÅ Projektstruktur

```
DS-Allroundservice-Website/
‚îÇ
‚îú‚îÄ‚îÄ üìÇ api/                                    # Backend API Endpoints
‚îÇ   ‚îú‚îÄ‚îÄ admin.php                              # Haupt-Admin-API (Services, Users, Settings, Submissions)
‚îÇ   ‚îú‚îÄ‚îÄ auth.php                               # Login/Logout Authentication
‚îÇ   ‚îú‚îÄ‚îÄ submit-questionnaire.php               # Fragebogen-Submission Handler
‚îÇ   ‚îú‚îÄ‚îÄ questionnaire_api.php                  # Fragebogen REST-API
‚îÇ   ‚îú‚îÄ‚îÄ questionnaire-builder.php              # Fragebogen-Builder API (CRUD)
‚îÇ   ‚îî‚îÄ‚îÄ clear-success-session.php              # Session Cleanup nach Erfolgsseite
‚îÇ
‚îÇ
‚îú‚îÄ‚îÄ üìÇ public/                                 # √ñffentlich zug√§ngliche Assets
‚îÇ   ‚îî‚îÄ‚îÄ assets/
‚îÇ       ‚îú‚îÄ‚îÄ üìÇ css/                            # Stylesheets
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ admin.css                      # Admin-Panel Styles
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ home.css                       # Landing-Page Styles
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ services.css                   # Service-Seiten Styles
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ questionnaire.css              # Fragebogen Styles
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ dynamic-questionnaire.css      # Dynamischer Fragebogen Styles
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ questionnaire-builder.css      # Fragebogen-Builder Styles
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ login.css                      # Login-Seite Styles
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ law.css                        # Rechtliche Seiten Styles
‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ page-components.css            # Wiederverwendbare Komponenten
‚îÇ       ‚îÇ
‚îÇ       ‚îú‚îÄ‚îÄ üìÇ js/                             # JavaScript
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ admin.js                       # Admin-Panel Logik
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ admin-drag-drop.js             # Drag & Drop f√ºr Admin
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ dynamic-questionnaire.js       # Fragebogen Multi-Step Logik
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ questionnaire-builder.js       # Fragebogen-Builder Frontend
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ questionnaire-behavior.js      # Fragebogen-Verhalten
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ home-behavior.js               # Landing-Page Interaktionen
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ login.js                       # Login-Formular Logik
‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ sticky-header.js               # Sticky Header Behavior
‚îÇ       ‚îÇ
‚îÇ       ‚îî‚îÄ‚îÄ üìÇ img/                            # Bilder, Icons, Logos
‚îÇ           ‚îî‚îÄ‚îÄ (Logo, Service-Icons, etc.)
‚îÇ
‚îú‚îÄ‚îÄ üìÇ src/                                    # Source Code (MVC)
‚îÇ   ‚îú‚îÄ‚îÄ Router.php                             # Haupt-URL-Router
‚îÇ   ‚îú‚îÄ‚îÄ ServiceRouter.php                      # Spezial-Router f√ºr Service-Seiten
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ üìÇ Models/                             # Datenmodelle
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ Offer.php                          # Angebots-Modell (PDF-Generierung)
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ üìÇ Utils/                              # Utility-Klassen
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ auth_middleware.php                # Authentifizierungs-Middleware
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ EmailInbox.php                     # IMAP Email-Empfang
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ EmailInboxFallback.php             # Email-Fallback (ohne IMAP)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ EmailEventStore.php                # Email-Event Tracking
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ OfferPDFGenerator.php              # PDF-Generierung f√ºr Angebote
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ QuestionnaireSubmissionHandler.php # Fragebogen-Verarbeitung
‚îÇ   ‚îÇ
‚îÇ   ‚îî‚îÄ‚îÄ üìÇ Views/                              # View-Klassen (Pages)
‚îÇ       ‚îú‚îÄ‚îÄ Page.php                           # Basis-Page-Klasse (Template)
‚îÇ       ‚îú‚îÄ‚îÄ Home.php                           # Landing-Page / Startseite
‚îÇ       ‚îú‚îÄ‚îÄ ServicePage.php                    # Dynamische Service-Seiten
‚îÇ       ‚îú‚îÄ‚îÄ DynamicQuestionnaire.php           # Multi-Step Fragebogen
‚îÇ       ‚îú‚îÄ‚îÄ QuestionnaireSuccess.php           # Erfolgsseite nach Submission
‚îÇ       ‚îú‚îÄ‚îÄ QuestionnaireBuilder.php           # Admin: Fragebogen-Builder
‚îÇ       ‚îú‚îÄ‚îÄ AdminPage.php                      # Admin-Panel (Dashboard, Services, etc.)
‚îÇ       ‚îú‚îÄ‚îÄ LoginPage.php                      # Login-Formular
‚îÇ       ‚îú‚îÄ‚îÄ Contact.php                        # Kontakt-Seite
‚îÇ       ‚îú‚îÄ‚îÄ Impressum.php                      # Impressum
‚îÇ       ‚îú‚îÄ‚îÄ AGB.php                            # Allgemeine Gesch√§ftsbedingungen
‚îÇ       ‚îú‚îÄ‚îÄ Datenschutz.php                    # Datenschutzerkl√§rung
‚îÇ       ‚îî‚îÄ‚îÄ CookieHandler.php                  # Cookie-Consent Handler
‚îÇ
‚îÇ
‚îú‚îÄ‚îÄ üìÇ debug/                                  # Debug & Entwickler-Tools
‚îÇ   ‚îî‚îÄ‚îÄ (Debug-Scripts, Password-Reset, etc.)  # Nicht f√ºr Produktion
‚îÇ
‚îú‚îÄ‚îÄ üìÇ tests/                                  # Test-Suite
‚îÇ   ‚îú‚îÄ‚îÄ AdminPageTest.php                      # 40 Unit Tests
‚îÇ   ‚îú‚îÄ‚îÄ AdminPageIntegrationTest.php           # 54 Integration Tests
‚îÇ   ‚îî‚îÄ‚îÄ (weitere Test-Dateien)                 # PDF-Tests, Setup-Scripts
‚îÇ
‚îú‚îÄ‚îÄ üìÇ vendor/                                 # Composer Dependencies
‚îÇ   ‚îú‚îÄ‚îÄ autoload.php                           # Composer Autoloader
‚îÇ   ‚îî‚îÄ‚îÄ tecnickcom/tcpdf/                      # TCPDF Library (PDF-Generierung)
‚îÇ
‚îú‚îÄ‚îÄ üìÇ .idea/                                  # PhpStorm IDE Config (gitignored)
‚îÇ
‚îú‚îÄ‚îÄ .htaccess                                  # Apache URL-Rewriting
‚îú‚îÄ‚îÄ .gitignore                                 # Git Ignore Rules
‚îú‚îÄ‚îÄ index.php                                  # Application Entry Point
‚îú‚îÄ‚îÄ composer.json                              # Composer Dependencies
‚îú‚îÄ‚îÄ composer.lock                              # Locked Dependency Versions
‚îú‚îÄ‚îÄ database.db                                # SQLite Haupt-Datenbank
‚îú‚îÄ‚îÄ db-sqlite.sql                              # DB-Schema (SQL)
‚îú‚îÄ‚îÄ DS-Allroundservice_Admin-Anleitung.pdf     # Admin-Handbuch
‚îú‚îÄ‚îÄ README.md                                  # Projekt-Dokumentation (diese Datei)
‚îî‚îÄ‚îÄ TODO.md                                    # Entwicklungs-TODO-Liste

```

### üìã Verzeichnis-Beschreibungen

| Verzeichnis | Zweck | Wichtigste Dateien |
|-------------|-------|-------------------|
| **api/** | Backend REST-APIs | `admin.php`, `auth.php`, `submit-questionnaire.php` |
| **public/** | Frontend Assets (CSS, JS, Images) | Alle √∂ffentlich zug√§nglichen Dateien |
| **src/** | PHP Anwendungscode (MVC) | Models, Views, Utils, Router |
| **data/** | Uploads & generierte Dateien | PDFs, Datenbank, Submissions |
| **debug/** | Entwicklungs-Tools | Password-Reset, Event-Store-Reset |
| **tests/** | Automatisierte Tests | 94 Unit & Integration Tests |
| **vendor/** | Composer Packages | TCPDF, andere Dependencies |

### üóÇÔ∏è Wichtigste Dateien

**Entry Point:**
- `index.php` - Application Bootstrap, Routing, DB-Init

**Datenbank:**
- `database.db` - SQLite Haupt-Datenbank
- `db-sqlite.sql` - SQL-Schema f√ºr Setup

**Konfiguration:**
- `composer.json` - PHP Dependencies
- `.htaccess` - Apache URL-Rewriting
- `.gitignore` - Ausgeschlossene Dateien

**Dokumentation:**
- `README.md` - Vollst√§ndige Projekt-Doku
- `TODO.md` - Entwicklungs-Roadmap
- `DS-Allroundservice_Admin-Anleitung.pdf` - Admin-Handbuch

---

## üöÄ Installation

### Voraussetzungen
- PHP 7.4 oder h√∂her
- SQLite3
- Composer
- IMAP Extension (optional, f√ºr Email-Funktion)

### Schritt 1: Repository klonen
```bash
git clone https://github.com/christoph-henz/DS-Allroundservice-Website-public.git
cd DS-Allroundservice-Website
```

### Schritt 2: Dependencies installieren
```bash
composer install
```

### Schritt 3: Datenbank initialisieren
```bash
# SQLite-Datenbank wird automatisch erstellt
# Optional: SQL-Schema laden
sqlite3 database.db
```

### Schritt 4: Konfiguration anpassen
```php
// config/database.php
define('DB_PATH', __DIR__ . '/../database.db');

// Email-Einstellungen (optional)
define('IMAP_HOST', '{imap.example.com:993/imap/ssl}INBOX');
define('IMAP_USER', 'your-email@example.com');
define('IMAP_PASSWORD', 'your-password');   hashed
```

### Schritt 5: Webserver starten
```bash
# PHP Built-in Server
php -S localhost:8000

# Oder Apache/Nginx konfigurieren
```

### Schritt 6: Admin-Login
```
URL: http://localhost:8000/admin
Username: admin
Password: [siehe Datenbank oder reset_admin_password.php verwenden]
```

---

## üîß Verwendung

### Neuen Service erstellen
1. Admin-Panel √∂ffnen (`/admin`)
2. "Services" ‚Üí "Neuer Service"
3. Name, Slug, Beschreibung eingeben
4. Pricing-Daten konfigurieren
5. SEO-Metadaten hinzuf√ºgen
6. Speichern & Aktivieren

### Fragebogen erstellen
1. Admin-Panel ‚Üí "Questionnaires"
2. "Neuer Fragebogen"
3. Titel & Service ausw√§hlen
4. Fragen hinzuf√ºgen (Drag & Drop Reihenfolge)
5. Validierung konfigurieren
6. Auf "Active" setzen

### Angebot erstellen
1. Admin-Panel ‚Üí "Submissions"
2. Anfrage ausw√§hlen
3. "Angebot erstellen"
4. Positionen hinzuf√ºgen
5. Preise eingeben
6. PDF generieren & versenden

---

## üìä Datenbank-Schema

### Wichtigste Tabellen

**services**
- Speichert alle Service-Definitionen
- JSON pricing_data f√ºr flexible Preisstrukturen

**questionnaire_submissions**
- Speichert eingehende Anfragen
- JSON form_data f√ºr flexible Frageb√∂gen
- Status-Tracking (new, in_progress, completed, cancelled)

**users**
- Benutzer-Accounts mit Rollen
- Bcrypt Password Hashing
- Soft-Delete Support

**questionnaires & questions**
- Dynamische Fragebogen-Definitionen
- Conditional Logic Support
- Versions-Verwaltung

**settings**
- Key-Value Einstellungen
- Typisierte Werte (string, number, boolean, json)
- Public/Private Flag

**service_page_content**
- SEO & Content f√ºr Service-Seiten
- 1:1 Beziehung zu services

---

## üîê Sicherheit

### Implementierte Sicherheitsma√ünahmen

‚úÖ **Authentifizierung:**
- Password Hashing (bcrypt)
- Session Management
- Role-Based Access Control (RBAC)

‚úÖ **Input Validation:**
- Server-side Validierung
- Prepared Statements (SQL-Injection Prevention)
- XSS-Protection (htmlspecialchars)

‚úÖ **Session Security:**
- Session-basierte Daten√ºbergabe (keine GET-Parameter f√ºr sensitive Daten)
- Session Cleanup
- beforeunload Protection

‚úÖ **Database:**
- PDO mit Prepared Statements
- Foreign Key Constraints
- Soft Deletes (Daten-Integrit√§t)

### Geplante Sicherheitsverbesserungen

‚è≥ **PHP API-Endpunkte absichern:**
- CSRF-Token Implementation
- Rate Limiting
- Input Sanitization erweitern

‚è≥ **JavaScript API-Aufrufe absichern:**
- XSS-Protection erweitern
- Content Security Policy (CSP)

‚è≥ **Session-Sicherheit h√§rten:**
- Secure Cookies
- Session Timeout
- HTTPS-only Flag

---

## üìù Entwicklung

### Code-Style
- PSR-12 Coding Standard
- OOP Design Patterns
- MVC Architecture
- Dependency Injection

### Testing ausf√ºhren
```bash
# Unit Tests
php tests/AdminPageTest.php

# Integration Tests
php tests/AdminPageIntegrationTest.php

# Alle Tests
php tests/AdminPageTest.php && php tests/AdminPageIntegrationTest.php
```

### Debug-Modus aktivieren
```php
// debug/DEBUG_MODE_README.md
// Verschiedene Debug-Tools verf√ºgbar
```

---

## üìÑ Lizenz

Proprietary - Alle Rechte vorbehalten

---

## üë• Kontakt

**DS-Allroundservice**
- Website: [DS-Allroundservice.de](https://ds-allroundservice.de)
- Email: christophhenz@gmail.com

---

## üéØ Roadmap

### Aktuelle Version
- ‚úÖ Vollst√§ndiges Admin-Panel
- ‚úÖ Dynamische Frageb√∂gen
- ‚úÖ PDF-Generierung
- ‚úÖ Email-Integration
- ‚úÖ Umfassende Tests (94 Tests)

### N√§chste Features
- ‚è≥ Email schreiben/antworten aus Admin-Panel
- ‚è≥ Automatisches Laden neuer Emails
- ‚è≥ API-Sicherheits-H√§rtung
- ‚è≥ Performance-Optimierung
- ‚è≥ Multi-Language Support
- ‚è≥ Advanced Analytics Dashboard

---

**Letzte Aktualisierung:** 9. Oktober 2025